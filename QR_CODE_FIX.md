# QR Code Registration Fix

## Problem
QR codes generated by the API were not valid when accessed from the browser.

## Root Causes Identified

1. **Timing Issue**: The initial response was sent before the QR code was fully generated
2. **No QR Refresh**: WhatsApp QR codes expire and refresh periodically, but the status endpoint didn't return updated QR codes
3. **No Timeout Handling**: If QR code generation failed, the API would return an empty QR code

## Solutions Implemented

### 1. **Synchronous QR Code Generation**
**File**: `internal/application/sender_registration_service.go`

**Before**:
```go
// Wait a moment for the first QR code
time.Sleep(1 * time.Second)
```

**After**:
```go
// Wait for the first QR code with timeout
firstQRReceived := make(chan bool, 1)
go func() {
    for evt := range qrChan {
        if evt.Event == "code" {
            qrBytes := generateQRCodePNG(evt.Code)
            session.mu.Lock()
            session.QRCode = base64.StdEncoding.EncodeToString(qrBytes)
            session.mu.Unlock()
            
            // Signal that first QR is ready
            select {
            case firstQRReceived <- true:
            default:
            }
        }
    }
}()

select {
case <-firstQRReceived:
    // QR code ready
case <-time.After(5 * time.Second):
    // Timeout - return error
    return &domain.RegisterSenderQRResponse{
        Success: false,
        Message: "Timeout waiting for QR code generation",
    }, fmt.Errorf("timeout waiting for QR code")
}
```

**Benefits**:
- Guarantees QR code is ready before API responds
- Handles timeout scenarios gracefully
- Returns error if QR generation fails

### 2. **QR Code Refresh Support**
**File**: `internal/application/sender_registration_service.go`

**Before**:
```go
// Note: We don't send QR code in status response to reduce payload
```

**After**:
```go
// Include updated QR code for pending registrations (QR codes can refresh)
if status == "pending" && qrCode != "" {
    // QR codes expire and refresh, so we need to send the latest one
    response.QRCode = qrCode
}
```

**Benefits**:
- Clients can poll for updated QR codes
- Handles QR code expiration automatically
- Better user experience (no need to restart registration)

### 3. **Enhanced Response Model**
**File**: `internal/domain/entities.go`

**Added** `QRCode` field to `RegistrationStatusResponse`:
```go
type RegistrationStatusResponse struct {
    Success   bool   `json:"success"`
    Status    string `json:"status"`
    SenderID  string `json:"sender_id,omitempty"`
    QRCode    string `json:"qr_code,omitempty"`   // NEW: Updated QR code
    Message   string `json:"message,omitempty"`
}
```

**Benefits**:
- Status endpoint can return refreshed QR codes
- Single endpoint for both status and QR updates

## Testing

### Test Page Created
**File**: `web/test-qr-registration.html`

A complete HTML test page with:
- QR code display
- Real-time status polling
- QR code refresh handling
- Both QR and pairing code methods
- Configuration UI

**Access**: `http://localhost:8080/web/test-qr-registration.html`

### Test Script Created
**File**: `test-registration-api.sh`

Automated testing script that:
- Tests QR registration endpoint
- Validates QR code presence
- Saves QR code as PNG file
- Checks registration status
- Lists available senders

**Usage**:
```bash
export API_PASSWORD='your_password'
./test-registration-api.sh
```

## Usage Examples

### 1. Web Browser (Recommended)

```javascript
// Start registration
const response = await fetch('http://localhost:8080/api/register-sender-qr', {
    method: 'POST',
    headers: {
        'Authorization': 'Basic ' + btoa('admin:password')
    }
});

const { session_id, qr_code } = await response.json();

// Display QR code
document.getElementById('qr').src = `data:image/png;base64,${qr_code}`;

// Poll for status and QR updates
setInterval(async () => {
    const status = await fetch(
        `http://localhost:8080/api/register-sender-status/${session_id}`,
        { headers: { 'Authorization': 'Basic ' + btoa('admin:password') } }
    );
    const data = await status.json();
    
    // Update QR if it changed (refresh scenario)
    if (data.qr_code) {
        document.getElementById('qr').src = `data:image/png;base64,${data.qr_code}`;
    }
    
    if (data.status === 'connected') {
        alert(`Success! Sender: ${data.sender_id}`);
        clearInterval(this);
    }
}, 2000);
```

### 2. cURL Testing

```bash
# Start registration and get session ID
RESPONSE=$(curl -s -X POST http://localhost:8080/api/register-sender-qr \
    -u admin:password)

SESSION_ID=$(echo $RESPONSE | jq -r '.session_id')
QR_CODE=$(echo $RESPONSE | jq -r '.qr_code')

# Save QR code as image
echo $QR_CODE | base64 -d > qr_code.png
open qr_code.png  # macOS
# xdg-open qr_code.png  # Linux

# Check status (will include updated QR if it refreshed)
curl -s http://localhost:8080/api/register-sender-status/$SESSION_ID \
    -u admin:password | jq '.'
```

### 3. Python

```python
import requests
import base64
from PIL import Image
from io import BytesIO
import time

# Start registration
response = requests.post(
    'http://localhost:8080/api/register-sender-qr',
    auth=('admin', 'password')
)
data = response.json()

session_id = data['session_id']
qr_base64 = data['qr_code']

# Display QR code
qr_bytes = base64.b64decode(qr_base64)
Image.open(BytesIO(qr_bytes)).show()

# Poll for status
while True:
    status = requests.get(
        f'http://localhost:8080/api/register-sender-status/{session_id}',
        auth=('admin', 'password')
    ).json()
    
    # Update QR if it changed
    if status.get('qr_code'):
        qr_bytes = base64.b64decode(status['qr_code'])
        Image.open(BytesIO(qr_bytes)).show()
    
    if status['status'] == 'connected':
        print(f"✓ Success! Sender: {status['sender_id']}")
        break
    
    time.sleep(2)
```

## API Behavior

### Initial Registration (`POST /api/register-sender-qr`)

**Response**:
```json
{
  "success": true,
  "session_id": "uuid-here",
  "qr_code": "iVBORw0KGgoAAAANSUhEUg...",
  "message": "QR code generated. Please scan with WhatsApp."
}
```

**Guarantees**:
- `qr_code` is ALWAYS present if `success: true`
- QR code is fully generated and valid
- Timeout after 5 seconds if generation fails

### Status Check (`GET /api/register-sender-status/:sessionId`)

**Response (Pending)**:
```json
{
  "success": true,
  "status": "pending",
  "qr_code": "iVBORw0KGg...",  // Updated if refreshed
  "message": "Waiting for WhatsApp pairing..."
}
```

**Response (Connected)**:
```json
{
  "success": true,
  "status": "connected",
  "sender_id": "1234567890",
  "message": "Successfully registered! Sender ID: 1234567890"
}
```

## Verification Steps

1. **Build**: `make build`

2. **Start Server**: `./whatspoints`

3. **Test with Script**:
   ```bash
   export API_PASSWORD='your_password'
   ./test-registration-api.sh
   ```

4. **Test with Browser**:
   - Open: `http://localhost:8080/web/test-qr-registration.html`
   - Enter credentials
   - Click "Start QR Registration"
   - Verify QR code displays correctly
   - Scan with WhatsApp

5. **Verify QR Code**:
   ```bash
   # The script saves QR to /tmp/qr_code.png
   open /tmp/qr_code.png
   ```

## Technical Details

### QR Code Format
- **Encoding**: Base64
- **Image Format**: PNG
- **Size**: 256x256 pixels
- **Error Correction**: Medium level
- **Library**: `github.com/skip2/go-qrcode`

### Session Management
- Sessions stored in-memory
- Expire after 10 minutes
- Automatic cleanup
- Thread-safe with mutex locks

### WhatsApp Integration
- Uses `whatsmeow` library
- QR codes auto-refresh before expiry
- Event-driven architecture
- Handles connection/disconnection

## Troubleshooting

### QR Code Still Invalid?

1. **Check QR Code Length**:
   ```bash
   # Should be > 1000 characters
   curl -s http://localhost:8080/api/register-sender-qr \
       -u admin:pass | jq -r '.qr_code' | wc -c
   ```

2. **Verify Base64 Encoding**:
   ```bash
   QR=$(curl -s http://localhost:8080/api/register-sender-qr \
       -u admin:pass | jq -r '.qr_code')
   echo $QR | base64 -d > test.png
   file test.png  # Should say "PNG image data"
   ```

3. **Check Server Logs**:
   Look for "QR code generated" messages

4. **Test Direct API**:
   Use the test script: `./test-registration-api.sh`

### Common Issues

**Issue**: QR code is null or empty
**Solution**: Check server logs for errors, ensure WhatsApp service is running

**Issue**: QR code expires quickly
**Solution**: Poll status endpoint every 2 seconds for updated QR codes

**Issue**: Browser shows broken image
**Solution**: Verify data URL format: `data:image/png;base64,<base64_string>`

## Files Changed

1. ✅ `internal/application/sender_registration_service.go` - Fixed QR generation timing
2. ✅ `internal/domain/entities.go` - Added QR field to status response
3. ✅ `web/test-qr-registration.html` - Created test page
4. ✅ `test-registration-api.sh` - Created test script
5. ✅ `API_SENDER_REGISTRATION.md` - API documentation
6. ✅ `QR_CODE_FIX.md` - This file

## Next Steps

1. Test with real WhatsApp account
2. Monitor QR code refresh behavior
3. Add webhook support for completion notifications
4. Consider adding QR code expiration timer in UI
5. Add metrics/logging for registration success rate
